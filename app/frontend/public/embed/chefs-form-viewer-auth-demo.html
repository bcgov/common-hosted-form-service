<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHEFS Form Viewer – authToken Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 1rem;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }
      .col {
        display: flex;
        flex-direction: column;
        min-width: 220px;
      }
      label {
        font-size: 0.8rem;
        color: #444;
        margin-bottom: 0.25rem;
      }
      input[type='text'],
      textarea {
        padding: 0.35rem 0.5rem;
        font-size: 0.95rem;
      }
      .controls {
        display: flex;
        gap: 0.5rem;
        margin: 0.75rem 0 1rem;
        flex-wrap: wrap;
      }
      button {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
      }
      .viewer {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.5rem;
        margin-top: 1rem;
      }
      .log {
        margin-top: 1rem;
        background: #f9fafb;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 0.5rem;
        max-height: 240px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
        font-size: 12px;
      }
      .token {
        width: 100%;
        font-size: 0.95rem;
        background: #f4f8fc;
        border: 1px solid #b0d4f1;
        border-radius: 4px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        resize: none;
      }
    </style>
    <script defer src="./chefs-form-viewer.js"></script>
  </head>
  <body>
    <h2>chefs-form-viewer – authToken Demo</h2>
    <div class="row">
      <div class="col">
        <label for="formId">Form ID (UUID)</label>
        <input
          id="formId"
          type="text"
          placeholder="11111111-1111-1111-1111-111111111111"
        />
      </div>
      <div class="col">
        <label for="apiKey">API Key</label>
        <input id="apiKey" type="text" placeholder="secret" />
      </div>
      <div class="col">
        <label for="submissionId">Submission ID (optional)</label>
        <input id="submissionId" type="text" placeholder="(for preload)" />
      </div>
      <div class="col">
        <label for="token">Token</label>
        <textarea id="token" class="token" rows="2" readonly></textarea>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label for="readOnly">
          <input type="checkbox" id="readOnly" /> Read Only
        </label>
      </div>
      <div class="col">
        <label for="debug">
          <input type="checkbox" id="debug" checked /> Debug
        </label>
      </div>
    </div>
    <div class="controls">
      <button id="getTokenBtn" disabled>Get Token</button>
      <button id="loadFormBtn" disabled>Load Form</button>
      <button id="clearBtn">Clear / Reset</button>
    </div>
    <div id="viewerHost" class="viewer"></div>
    <div class="log" id="eventLog"></div>
    <script>
      const $ = (id) => document.getElementById(id);
      const logEl = $('eventLog');
      function log(line, meta) {
        const el = document.createElement('div');
        let suffix = '';
        if (meta !== undefined) {
          suffix =
            ' ' +
            (typeof meta === 'string' ? meta : JSON.stringify(meta, null, 2));
        }
        el.textContent = `[${new Date().toISOString()}] ${line}${suffix}`;
        logEl.prepend(el);
      }
      function updateButtonStates() {
        const formId = $('formId').value.trim();
        const apiKey = $('apiKey').value.trim();
        const token = $('token').value.trim();
        $('getTokenBtn').disabled = !(formId && apiKey);
        $('loadFormBtn').disabled = !token;
      }
      for (const id of ['formId', 'apiKey', 'token']) {
        $(id).addEventListener('input', updateButtonStates);
      }
      $('readOnly').addEventListener('change', updateButtonStates);
      $('debug').addEventListener('change', updateButtonStates);
      // Helper to determine base path (/app or /pr-xxxx)
      function getBasePath() {
        const { pathname } = window.location;
        const match = pathname.match(/^\/(app|pr-\d+)/);
        return match ? `/${match[1]}` : '/app';
      }
      // Simulate token fetch (replace with real API call as needed)
      async function fetchToken(formId, apiKey) {
        // Replace with your backend endpoint
        const url = `${getBasePath()}/gateway/v1/auth/token/forms/${formId}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Basic ' + btoa(`${formId}:${apiKey}`),
          },
          body: JSON.stringify({ formId }),
        });
        if (!res.ok) {
          throw new Error('Failed to fetch token: ' + res.status);
        }
        const data = await res.json();
        return data.token || '';
      }
      $('getTokenBtn').addEventListener('click', async () => {
        const formId = $('formId').value.trim();
        const apiKey = $('apiKey').value.trim();
        $('getTokenBtn').disabled = true;
        log('Requesting token...');
        try {
          const token = await fetchToken(formId, apiKey);
          $('token').value = token;
          log('Token received', token);
          updateButtonStates();
        } catch (e) {
          log('Token fetch error', e.message);
          $('token').value = '';
        } finally {
          $('getTokenBtn').disabled = false;
        }
      });
      function loadViewer() {
        const formId = $('formId').value.trim();
        const token = $('token').value.trim();
        const submissionId = $('submissionId').value.trim();
        const readOnly = $('readOnly').checked;
        const debug = $('debug').checked;
        const host = $('viewerHost');
        host.innerHTML = '';
        if (!formId || !token) return;
        const el = document.createElement('chefs-form-viewer');
        el.setAttribute('form-id', formId);
        el.setAttribute('auth-token', token);
        if (submissionId) el.setAttribute('submission-id', submissionId);
        if (readOnly) el.setAttribute('read-only', 'true');
        if (debug) el.setAttribute('debug', 'true');
        // Listen to all events
        el.addEventListener('*', (e) => {
          log(e.type, e.detail);
        });
        // Listen to all known events
        for (const evt of [
          'formio:ready',
          'formio:error',
          'formio:loadSchema',
          'formio:submit',
          'formio:submitDone',
          'formio:change',
          'formio:render',
          'formio:authTokenRefreshed',
          'formio:assetStateChange',
          'formio:beforeLoad',
          'formio:beforeLoadSchema',
          'formio:beforeInit',
        ]) {
          el.addEventListener(evt, (e) => log(evt, e.detail));
        }
        // On successful submit, update submissionId, set readOnly, reload
        el.addEventListener('formio:submitDone', (e) => {
          const sub = e.detail?.submission;
          const sid =
            sub?.id ||
            sub?.submission?.id ||
            sub?.submissionId ||
            sub?.data?.id ||
            null;
          if (sid) {
            $('submissionId').value = String(sid);
            $('readOnly').checked = true;
            log(
              'Auto-reloading viewer in readonly mode with submissionId',
              sid
            );
            setTimeout(loadViewer, 100);
          } else {
            log('Could not determine submissionId from submitDone payload');
          }
        });
        host.appendChild(el);
        el.load().catch((e) => log('load:error', { message: e?.message }));
      }
      $('loadFormBtn').addEventListener('click', loadViewer);
      $('clearBtn').addEventListener('click', () => {
        $('viewerHost').innerHTML = '';
        $('submissionId').value = '';
        $('token').value = '';
        $('readOnly').checked = false;
        $('debug').checked = true;
        log('Cleared viewer and reset fields');
        updateButtonStates();
      });
      updateButtonStates();
    </script>
  </body>
</html>
