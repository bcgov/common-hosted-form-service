<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHEFS Form Viewer - Theme Demo</title>
    <style>
      :root {
        --primary: #3498db;
        --primary-dark: #2980b9;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --border: #bdc3c7;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        line-height: 1.6;
        margin: 0;
        background: #f8f9fa;
        color: var(--dark);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0 0 1rem 0;
        color: var(--primary);
        font-size: 2.5rem;
      }

      .header p {
        margin: 0;
        font-size: 1.1rem;
        color: #666;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 2rem;
      }

      .card-header {
        background: var(--primary);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .card-body {
        padding: 1.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark);
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.9rem;
        font-family: inherit;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      }

      .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #666;
        font-size: 0.8rem;
      }

      .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        width: 100%;
      }

      .btn:hover:not(:disabled) {
        background: var(--primary-dark);
      }

      .btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-success {
        background: var(--success);
      }

      .btn-success:hover:not(:disabled) {
        background: #219a52;
      }

      .error-message {
        background: #fee;
        color: var(--danger);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        border: 1px solid #fcc;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      #form-container {
        margin-top: 2rem;
        min-height: 400px;
      }

      .info-box {
        background: #e8f4f8;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 4px;
      }

      .info-box p {
        margin: 0;
        color: #2c3e50;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>CHEFS Form Viewer - Theme Demo</h1>
        <p>
          Enter your form credentials and select a theme to see how forms can be
          customized
        </p>
      </div>

      <div class="card">
        <div class="card-header">Configuration</div>
        <div class="card-body">
          <div class="info-box">
            <p>
              <strong>How it works:</strong> Enter your Form ID and API Key,
              select a theme, then click Launch. The demo will fetch an
              authentication token and display your form with the selected theme
              applied.
            </p>
          </div>

          <div class="error-message" id="errorMessage"></div>

          <div class="form-group">
            <label for="formId">
              Form ID <span style="color: var(--danger)">*</span>
            </label>
            <input
              type="text"
              id="formId"
              placeholder="11111111-1111-1111-1111-111111111111"
            />
            <small>Your CHEFS form UUID</small>
          </div>

          <div class="form-group">
            <label for="apiKey">
              API Key <span style="color: var(--danger)">*</span>
            </label>
            <input
              type="password"
              id="apiKey"
              placeholder="Enter your API key"
            />
            <small>Used to fetch authentication token</small>
          </div>

          <div class="form-group">
            <label for="themeSelect">Theme</label>
            <select id="themeSelect">
              <option value="">Default (CHEFS)</option>
              <option value="./chefs-form-viewer-theme-dark.css">
                Dark Mode / Cyberpunk
              </option>
              <option value="./chefs-form-viewer-theme-material.css">
                Material Design / Playful
              </option>
            </select>
            <small>Select a theme to apply to the form</small>
          </div>

          <button class="btn btn-success" id="launchBtn" type="button">
            Launch Form
          </button>
        </div>
      </div>

      <div id="form-container"></div>
    </div>

    <script src="./chefs-form-viewer.js"></script>
    <script>
      // Helper function to get the current base URL (handles /app, /pr-####, etc.)
      function getBasePath() {
        const currentPath = globalThis.location.pathname;
        let basePath = '/app'; // default fallback
        if (currentPath.includes('/embed')) {
          basePath = currentPath.substring(0, currentPath.indexOf('/embed'));
        }
        return globalThis.location.origin + basePath;
      }

      // Convert relative URL to absolute URL
      function resolveThemeUrl(relativeUrl) {
        if (!relativeUrl) return null;
        // If already absolute, return as-is
        if (/^https?:\/\//.test(relativeUrl)) {
          return relativeUrl;
        }
        // Convert relative path to absolute URL
        const currentPath = globalThis.location.pathname;
        const embedIndex = currentPath.indexOf('/embed');
        const basePath =
          embedIndex >= 0 ? currentPath.substring(0, embedIndex) : '/app';
        // Handle relative paths starting with ./
        if (relativeUrl.startsWith('./')) {
          return (
            globalThis.location.origin +
            basePath +
            '/embed/' +
            relativeUrl.substring(2)
          );
        }
        // Handle paths starting with /
        if (relativeUrl.startsWith('/')) {
          return globalThis.location.origin + relativeUrl;
        }
        // Default: assume it's relative to /embed
        return globalThis.location.origin + basePath + '/embed/' + relativeUrl;
      }

      // Fetch auth token from backend
      async function fetchAuthToken(formId, apiKey) {
        const basePath = getBasePath();
        const url = `${basePath}/gateway/v1/auth/token/forms/${formId}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Basic ' + btoa(`${formId}:${apiKey}`),
          },
          body: JSON.stringify({ formId }),
        });
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(
            `Failed to fetch token: ${res.status} ${res.statusText}. ${errorText}`
          );
        }
        const data = await res.json();
        return data.token;
      }

      // Show error message
      function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        errorEl.textContent = message;
        errorEl.classList.add('show');
        setTimeout(() => {
          errorEl.classList.remove('show');
        }, 10000);
      }

      // Hide error message
      function hideError() {
        const errorEl = document.getElementById('errorMessage');
        errorEl.classList.remove('show');
      }

      // Launch form with selected theme
      async function launchForm() {
        const formId = document.getElementById('formId').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const themeSelect = document.getElementById('themeSelect');
        const selectedTheme = themeSelect.value;
        const launchBtn = document.getElementById('launchBtn');
        const formContainer = document.getElementById('form-container');

        // Validate inputs
        if (!formId) {
          showError('Please enter a Form ID');
          return;
        }
        if (!apiKey) {
          showError('Please enter an API Key');
          return;
        }

        // Clear previous form
        formContainer.innerHTML = '';
        hideError();

        // Disable button and show loading
        launchBtn.disabled = true;
        launchBtn.innerHTML = '<span class="loading"></span>Fetching token...';

        try {
          // Fetch token
          const token = await fetchAuthToken(formId, apiKey);
          if (!token) {
            throw new Error('No token received from server');
          }

          // Create form viewer element
          const viewer = document.createElement('chefs-form-viewer');
          viewer.setAttribute('form-id', formId);
          viewer.setAttribute('auth-token', token);
          if (selectedTheme) {
            // Convert relative path to absolute URL
            const absoluteThemeUrl = resolveThemeUrl(selectedTheme);
            viewer.setAttribute('theme-css', absoluteThemeUrl);
          }
          viewer.setAttribute('debug', 'true');

          // Append to container
          formContainer.appendChild(viewer);

          // Load form
          launchBtn.innerHTML = '<span class="loading"></span>Loading form...';
          await viewer.load();

          // Success - reset button
          launchBtn.disabled = false;
          launchBtn.textContent = 'Launch Form';
          launchBtn.classList.remove('btn-success');
          launchBtn.classList.add('btn');
          launchBtn.textContent = 'Reload Form';

          // Scroll to form
          formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } catch (error) {
          console.error('Error launching form:', error);
          showError(`Failed to launch form: ${error.message}`);
          launchBtn.disabled = false;
          launchBtn.innerHTML = 'Launch Form';
        }
      }

      // Add event listeners
      document.addEventListener('DOMContentLoaded', function () {
        const launchBtn = document.getElementById('launchBtn');
        launchBtn.addEventListener('click', launchForm);

        // Allow Enter key to launch
        document.getElementById('formId').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            launchForm();
          }
        });
        document.getElementById('apiKey').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            launchForm();
          }
        });
      });
    </script>
  </body>
</html>
