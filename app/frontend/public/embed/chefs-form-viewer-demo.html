<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHEFS Form Viewer Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 1rem;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }
      .col {
        display: flex;
        flex-direction: column;
        min-width: 260px;
      }
      label {
        font-size: 0.8rem;
        color: #444;
        margin-bottom: 0.25rem;
      }
      input[type='text'],
      select {
        padding: 0.35rem 0.5rem;
        font-size: 0.95rem;
      }
      .controls {
        display: flex;
        gap: 0.5rem;
        margin: 0.75rem 0 1rem;
        flex-wrap: wrap;
      }
      button {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
      }
      .viewer {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.5rem;
      }
      .log {
        margin-top: 1rem;
        background: #f9fafb;
        border: 1px solid #eee;
        border-radius: 4px;
        padding: 0.5rem;
        max-height: 240px;
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
        font-size: 12px;
      }
      .note {
        color: #555;
        font-size: 0.9rem;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
      }
      fieldset {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.75rem;
      }
      legend {
        padding: 0 0.5rem;
        color: #333;
        font-size: 0.9rem;
      }
    </style>
    <script defer src="./chefs-form-viewer.js"></script>
  </head>
  <body>
    <h2>chefs-form-viewer â€“ Embedding Demo</h2>
    <p class="note">
      This demo shows how to embed <code>&lt;chefs-form-viewer&gt;</code>,
      override URLs, and intercept/cancel events. Defaults target the CHEFS
      backend paths.
    </p>

    <div class="grid">
      <fieldset>
        <legend>Core</legend>
        <div class="row">
          <div class="col">
            <label for="formId">Form ID (UUID)</label>
            <input
              id="formId"
              type="text"
              placeholder="11111111-1111-1111-1111-111111111111"
            />
          </div>
          <div class="col">
            <label for="apiKey">API Key</label>
            <input id="apiKey" type="text" placeholder="secret" />
          </div>
          <div class="col">
            <label for="submissionId">Submission ID (optional)</label>
            <input id="submissionId" type="text" placeholder="(for preload)" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="baseUrl">Base URL</label>
            <input id="baseUrl" type="text" placeholder="https://host/app" />
          </div>
          <div class="col">
            <label for="language">Language</label>
            <select id="language">
              <option value="en" selected>en</option>
              <option value="fr">fr</option>
            </select>
          </div>
          <div class="col">
            <label for="readOnly">Read Only</label>
            <select id="readOnly">
              <option value="false" selected>false</option>
              <option value="true">true</option>
            </select>
          </div>
          <div class="col">
            <label for="debug">Debug</label>
            <select id="debug">
              <option value="false">false</option>
              <option value="true" selected>true</option>
            </select>
          </div>
          <div class="col">
            <label>
              <input type="checkbox" id="isolateStyles" /> Isolate styles
              (Shadow DOM)
            </label>
          </div>
          <div class="col">
            <label>
              <input type="checkbox" id="noIcons" /> Disable Font Awesome icons
            </label>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Endpoint Overrides</legend>
        <div class="row">
          <div class="col">
            <label for="mainCss">mainCss</label>
            <input id="mainCss" type="text" />
          </div>
          <div class="col">
            <label for="formioJs">formioJs</label>
            <input id="formioJs" type="text" />
          </div>
          <div class="col">
            <label for="componentsJs">componentsJs</label>
            <input id="componentsJs" type="text" />
          </div>
          <div class="col">
            <label for="themeCss">themeCss</label>
            <input id="themeCss" type="text" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="schemaUrl">schema</label>
            <input id="schemaUrl" type="text" />
          </div>
          <div class="col">
            <label for="submitUrl">submit</label>
            <input id="submitUrl" type="text" />
          </div>
          <div class="col">
            <label for="readSubmission">readSubmission</label>
            <input id="readSubmission" type="text" />
          </div>
        </div>
      </fieldset>
    </div>

    <div class="controls">
      <button id="loadBtn">Load</button>
      <button id="clearBtn">Clear</button>
      <button id="submitBtn">Submit (programmatic)</button>
    </div>

    <div id="viewerHost" class="viewer"></div>

    <div
      id="formMetadata"
      style="
        margin: 1rem 0;
        padding: 0.75rem;
        background: #f0f8ff;
        border: 1px solid #b0d4f1;
        border-radius: 4px;
        display: none;
      "
    >
      <h4 style="margin: 0 0 0.5rem 0; color: #2c5aa0">Form Information</h4>
      <div><strong>Name:</strong> <span id="formNameDisplay">-</span></div>
      <div>
        <strong>Description:</strong> <span id="formDescriptionDisplay">-</span>
      </div>
    </div>

    <div class="log" id="eventLog"></div>

    <script>
      const $ = (id) => document.getElementById(id);
      const logEl = $('eventLog');
      function safeStringify(value) {
        const seen = new WeakSet();
        try {
          return JSON.stringify(
            value,
            (k, v) => {
              if (typeof v === 'object' && v !== null) {
                if (seen.has(v)) return '[Circular]';
                seen.add(v);
              }
              return v;
            },
            2
          );
        } catch {
          return '[Unserializable]';
        }
      }

      function log(line, meta) {
        const el = document.createElement('div');
        let suffix = '';
        if (meta !== undefined) {
          suffix =
            ' ' + (typeof meta === 'string' ? meta : safeStringify(meta));
        }
        el.textContent = `[${new Date().toISOString()}] ${line}${suffix}`;
        logEl.prepend(el);
      }

      function displayFormMetadata(element) {
        // Access metadata via direct element properties (Approach 1)
        const formName = element.formName || 'N/A';
        const formDescription = element.formDescription || 'N/A';

        // Update the display
        $('formNameDisplay').textContent = formName;
        $('formDescriptionDisplay').textContent = formDescription;
        $('formMetadata').style.display = 'block';

        // Log the metadata access method for educational purposes
        log('Form metadata accessed via element properties:', {
          formName: element.formName,
          formDescription: element.formDescription,
          formMetadata: element.formMetadata ? 'Available' : 'Not available',
        });
      }

      function getBaseUrl() {
        const { origin, pathname } = window.location;
        const match = pathname.match(/^\/(app|pr-\d+)\b/);
        const baseSegment = match ? `/${match[1]}` : '/app';
        return `${origin}${baseSegment}`;
      }

      function defaultsFromBase(base, fid, sid) {
        return {
          mainCss: `${base}/webcomponents/v1/assets/chefs-index.css`,
          formioJs: `${base}/webcomponents/v1/assets/formio.js`,
          componentsJs: `${base}/webcomponents/v1/form-viewer/components`,
          themeCss: `${base}/webcomponents/v1/assets/chefs-theme.css`,
          schema: `${base}/webcomponents/v1/form-viewer/${
            fid || ':formId'
          }/schema`,
          submit: `${base}/webcomponents/v1/form-viewer/${
            fid || ':formId'
          }/submit`,
          readSubmission: `${base}/api/v1/submissions/${
            sid || ':submissionId'
          }`,
        };
      }

      function fillEndpointInputs(base, fid, sid) {
        const d = defaultsFromBase(base, fid, sid);
        $('mainCss').value = d.mainCss;
        $('formioJs').value = d.formioJs;
        $('componentsJs').value = d.componentsJs;
        $('themeCss').value = d.themeCss;
        $('schemaUrl').value = d.schema;
        $('submitUrl').value = d.submit;
        $('readSubmission').value = d.readSubmission;
      }

      function makeViewer() {
        const formId = $('formId').value.trim();
        const apiKey = $('apiKey').value.trim();
        const submissionId = $('submissionId').value.trim();
        const baseUrl = $('baseUrl').value.trim();
        const language = $('language').value;
        const readOnly = $('readOnly').value;
        const debug = $('debug').value;

        const host = $('viewerHost');
        host.innerHTML = '';
        const el = document.createElement('chefs-form-viewer');
        if (formId) el.setAttribute('form-id', formId);
        if (apiKey) el.setAttribute('api-key', apiKey);
        if (submissionId) el.setAttribute('submission-id', submissionId);
        if (baseUrl) el.setAttribute('base-url', baseUrl);
        if (language) el.setAttribute('language', language);
        if (readOnly) el.setAttribute('read-only', readOnly);
        if (debug) el.setAttribute('debug', debug);
        if ($('isolateStyles')?.checked)
          el.setAttribute('isolate-styles', 'true');
        if ($('noIcons')?.checked) el.setAttribute('no-icons', 'true');

        // Endpoint overrides (resolve :formId / :submissionId placeholders at click time)
        const r = (s) =>
          s.replace(/:formId/g, formId).replace(/:submissionId/g, submissionId);
        el.endpoints = {
          mainCss: r($('mainCss').value.trim()),
          formioJs: r($('formioJs').value.trim()),
          componentsJs: r($('componentsJs').value.trim()),
          themeCss: r($('themeCss').value.trim()),
          // Icons: override if desired (defaults to FA 4.7 in component)
          // iconsCss: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css',
          schema: r($('schemaUrl').value.trim()),
          submit: r($('submitUrl').value.trim()),
          readSubmission: r($('readSubmission').value.trim()),
        };

        // Event logging
        const logAll = (name) => (e) => log(name, e.detail);
        el.addEventListener('formio:ready', logAll('ready'));
        el.addEventListener('formio:error', logAll('error'));
        el.addEventListener('formio:loadSchema', (e) => {
          logAll('loadSchema')(e);
          // Display form metadata using direct element properties (Approach 1)
          displayFormMetadata(el);
        });

        el.addEventListener('formio:submit', logAll('submit'));
        el.addEventListener('formio:submitDone', (e) => {
          logAll('submitDone')(e);
          // Extract submission id and populate the input
          const sub = e.detail?.submission;
          const sid =
            sub?.id ||
            sub?.submission?.id ||
            sub?.submissionId ||
            sub?.data?.id ||
            null;
          if (sid) {
            $('submissionId').value = String(sid);
            $('readOnly').value = 'true';
            // Re-load the viewer to show readonly submission
            makeViewer();
            log('Re-loaded viewer in readonly mode with submissionId', sid);
          } else {
            log('Could not determine submissionId from submitDone payload');
          }
        });

        // Interception examples
        // Keep simple: remove interception hooks for a cleaner demo

        host.appendChild(el);
        el.load().catch((e) => log('load:error', { message: e?.message }));
      }

      $('loadBtn').addEventListener('click', makeViewer);
      $('clearBtn').addEventListener('click', () => {
        $('viewerHost').innerHTML = '';
        $('formMetadata').style.display = 'none';
        log('Cleared');
      });
      $('submitBtn').addEventListener('click', () => {
        const el = document.querySelector('chefs-form-viewer');
        el?.submit();
      });

      // Prefill base and endpoints
      const base = getBaseUrl();
      $('baseUrl').placeholder = base;
      fillEndpointInputs(
        base,
        $('formId').value.trim(),
        $('submissionId').value.trim()
      );
      // Whenever base URL changes, refresh defaults if inputs are empty
      $('baseUrl').addEventListener('input', () => {
        const b = $('baseUrl').value.trim() || base;
        fillEndpointInputs(
          b,
          $('formId').value.trim(),
          $('submissionId').value.trim()
        );
      });
      // Keep endpoints in sync with formId/submissionId when they change
      $('formId').addEventListener('input', () => {
        const b = $('baseUrl').value.trim() || base;
        fillEndpointInputs(
          b,
          $('formId').value.trim(),
          $('submissionId').value.trim()
        );
      });
      $('submissionId').addEventListener('input', () => {
        const b = $('baseUrl').value.trim() || base;
        fillEndpointInputs(
          b,
          $('formId').value.trim(),
          $('submissionId').value.trim()
        );
      });
    </script>
  </body>
</html>
