name: PR Deploy
run-name: Deploy PR-${{ github.event.inputs.pr-number }}

env:
  ACRONYM: chefs

on:
  workflow_dispatch:
    inputs:
      pr-number:
        description: Pull request number
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.pr-number || github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy
    environment:
      name: pr
    runs-on: ubuntu-latest
    timeout-minutes: 12
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy Crunchy
        uses: bcgov/action-crunchy@v1.1.0
        id: deploy_crunchy
        with:
          oc_namespace: ${{ vars.NAMESPACE_PREFIX }}-dev
          oc_token: ${{ secrets.OPENSHIFT_TOKEN }}
          values_file: openshift/crunchydb/charts/crunchy-postgres/values.yaml
          triggers: ./app