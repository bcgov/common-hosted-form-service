name: Cypress Tests
on:
 workflow_dispatch:
  inputs:
      pr-number:
        description: Pull request number
        required: false
        type: string
  
jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    outputs:
      PR_FINAL:  ${{ steps.vars.outputs.PR_FINAL }}
    steps:
     - name: Checkout
       uses: actions/checkout@v4
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '20'
         
     - name: cache
       uses: actions/cache@v4
       with:
            path: "tests/functional"
            key: node-modules-${{ hashFiles('tests/functional/package.json') }}

     
     - name: Set variables
       id: vars
       env:
         PR_NUMBER: ${{ github.event.inputs.pr-number }}
        
       run: |
          
          if [[ "$PR_NUMBER" != '' ]]; then
         
            echo "PR_FINAL=pr-$PR_NUMBER" >> "$GITHUB_OUTPUT"
          
          else

            echo "PR_FINAL=app" >> "$GITHUB_OUTPUT"
          fi
           
         
         
     - name: cypress install
       uses: cypress-io/github-action@v6
       with:
          
          working-directory: '${{ github.workspace }}/tests/functional'
       
       
        
       env:
          CYPRESS_keycloakUsername: ${{secrets.keycloakUsername}}
          CYPRESS_keycloakPassword: ${{secrets.keycloakPassword}}
          CYPRESS_depEnv: ${{ steps.vars.PR_FINAL }}

          
     - uses: actions/upload-artifact@v4
       if: failure()
       with:
          name: cypress-screenshots
          path: '${{ github.workspace }}/tests/functional/screenshots'
          # mkdir artifacts
          # cp -r cypress/screenshots artifacts/screenshots
    # -  name: Archive Cypress report
        #uses: actions/upload-artifact@v2
        #with:
         #name: cypress-report
         #path: artifacts
