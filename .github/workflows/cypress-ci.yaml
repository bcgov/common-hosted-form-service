name: Cypress Tests
on: [push]
  
jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    steps:
     - name: Checkout
       uses: actions/checkout@v4
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '20'
         
     - name: cache
       uses: actions/cache@v4
       with:
            path: "tests/functional"
            key: node-modules-${{ hashFiles('tests/functional/package.json') }}

     - name: cypress install
       uses: cypress-io/github-action@v6
       with:
          
          working-directory: '${{ github.workspace }}/tests/functional'
       env:
          CYPRESS_keycloakUsername: ${{secrets.keycloakUsername}}
          CYPRESS_keycloakPassword: ${{secrets.keycloakPassword}}
            
            
     - name: Cypress install   
       run: |
        npm ci
        $(npm bin)/cypress verify
        
        
      

        
     - name: Run Cypress tests
       run: npm run test:chrome
       continue-on-error: false

     - name: Copy test execution screenshots
       run: |
           mkdir artifacts
           cp -r cypress/screenshots artifacts/screenshots
     -  name: Archive Cypress report
        uses: actions/upload-artifact@v2
        with:
         name: cypress-report
         path: artifacts
